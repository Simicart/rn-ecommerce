{"version":3,"sources":["useShippingInformation.js"],"names":["useShippingInformation","props","mutations","setDefaultAddressOnCartMutation","onSave","queries","getDefaultShippingQuery","getShippingInformationQuery","toggleActiveContent","toggleDrawer","cartId","isSignedIn","hasUpdate","setHasUpdate","hasLoadedData","data","shippingInformationData","loading","getShippingInformationLoading","skip","variables","defaultShippingData","getDefaultShippingLoading","setDefaultAddressOnCart","setDefaultAddressLoading","isLoading","shippingData","filteredData","cart","email","shipping_addresses","shippingAddresses","length","primaryAddress","field","MOCKED_ADDRESS","doneEditing","city","updateTimer","undefined","current","setTimeout","clearTimeout","customer","default_shipping","defaultAddressId","addressId","parseInt","handleEditShipping"],"mappings":"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","sourcesContent":["import { useCallback, useEffect, useMemo, useState, useRef } from 'react';\nimport { useMutation, useQuery } from '@apollo/client';\n\nimport { useAppContext } from '../../../context/app';\nimport { useCartContext } from '../../../context/cart';\nimport { useUserContext } from '../../../context/user';\nimport { MOCKED_ADDRESS } from '../../CartPage/PriceAdjustments/ShippingMethods/useShippingForm';\n\nexport const useShippingInformation = props => {\n    const {\n        mutations: { setDefaultAddressOnCartMutation },\n        onSave,\n        queries: { getDefaultShippingQuery, getShippingInformationQuery },\n        toggleActiveContent\n    } = props;\n\n    const [, { toggleDrawer }] = useAppContext();\n    const [{ cartId }] = useCartContext();\n    const [{ isSignedIn }] = useUserContext();\n\n    const [hasUpdate, setHasUpdate] = useState(false);\n    const hasLoadedData = useRef(false);\n\n    const {\n        data: shippingInformationData,\n        loading: getShippingInformationLoading\n    } = useQuery(getShippingInformationQuery, {\n        skip: !cartId,\n        variables: {\n            cartId\n        }\n    });\n\n    const {\n        data: defaultShippingData,\n        loading: getDefaultShippingLoading\n    } = useQuery(getDefaultShippingQuery, { skip: !isSignedIn });\n\n    const [\n        setDefaultAddressOnCart,\n        { loading: setDefaultAddressLoading }\n    ] = useMutation(setDefaultAddressOnCartMutation);\n\n    const isLoading =\n        getShippingInformationLoading ||\n        getDefaultShippingLoading ||\n        setDefaultAddressLoading;\n\n    const shippingData = useMemo(() => {\n        let filteredData;\n        if (shippingInformationData) {\n            const { cart } = shippingInformationData;\n            const { email, shipping_addresses: shippingAddresses } = cart;\n            if (shippingAddresses.length) {\n                const primaryAddress = { ...shippingAddresses[0] };\n                for (const field in MOCKED_ADDRESS) {\n                    if (primaryAddress[field] === MOCKED_ADDRESS[field]) {\n                        primaryAddress[field] = '';\n                    }\n\n                    if (\n                        field === 'street' &&\n                        primaryAddress[field][0] === MOCKED_ADDRESS[field][0]\n                    ) {\n                        primaryAddress[field] = [''];\n                    }\n                }\n\n                filteredData = {\n                    email,\n                    ...primaryAddress\n                };\n            }\n        }\n\n        return filteredData;\n    }, [shippingInformationData]);\n\n    // Simple heuristic to check shipping data existed prior to this render.\n    // On first submission, when we have data, we should tell the checkout page\n    // so that we set the next step correctly.\n    const doneEditing = !!shippingData && !!shippingData.city;\n\n    useEffect(() => {\n        if (doneEditing) {\n            onSave();\n        }\n    }, [doneEditing, onSave]);\n\n    useEffect(() => {\n        let updateTimer;\n        if (shippingData !== undefined) {\n            if (hasLoadedData.current) {\n                setHasUpdate(true);\n                updateTimer = setTimeout(() => {\n                    setHasUpdate(false);\n                }, 2000);\n            } else {\n                hasLoadedData.current = true;\n            }\n        }\n\n        return () => {\n            if (updateTimer) {\n                clearTimeout(updateTimer);\n            }\n        };\n    }, [hasLoadedData, shippingData]);\n\n    useEffect(() => {\n        if (\n            shippingInformationData &&\n            !doneEditing &&\n            cartId &&\n            defaultShippingData\n        ) {\n            const { customer } = defaultShippingData;\n            const { default_shipping: defaultAddressId } = customer;\n            if (defaultAddressId) {\n                setDefaultAddressOnCart({\n                    variables: {\n                        cartId,\n                        addressId: parseInt(defaultAddressId)\n                    }\n                });\n            }\n        }\n    }, [\n        cartId,\n        doneEditing,\n        defaultShippingData,\n        setDefaultAddressOnCart,\n        shippingInformationData\n    ]);\n\n    const handleEditShipping = useCallback(() => {\n        if (isSignedIn) {\n            toggleActiveContent();\n        } else {\n            toggleDrawer('shippingInformation.edit');\n        }\n    }, [isSignedIn, toggleActiveContent, toggleDrawer]);\n\n    return {\n        doneEditing,\n        handleEditShipping,\n        hasUpdate,\n        isLoading,\n        isSignedIn,\n        shippingData\n    };\n};\n"]}