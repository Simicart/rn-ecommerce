{"version":3,"sources":["useAddressBook.js"],"names":["useAddressBook","props","mutations","setCustomerAddressOnCartMutation","queries","getCustomerAddressesQuery","getCustomerCartAddressQuery","toggleActiveContent","toggleDrawer","cartId","isSignedIn","addressCount","activeAddress","setActiveAddress","selectedAddress","setSelectedAddress","setCustomerAddressOnCart","error","setCustomerAddressOnCartError","loading","setCustomerAddressOnCartLoading","data","customerAddressesData","customerAddressesLoading","fetchPolicy","nextFetchPolicy","skip","customerCartAddressData","customerCartAddressLoading","derivedErrorMessage","isLoading","customerAddresses","customer","addresses","length","current","newestAddress","id","handleEditAddress","address","handleAddAddress","handleSelectAddress","addressId","customerCart","shipping_addresses","shippingAddresses","primaryCartAddress","foundSelectedAddress","find","customerAddress","street","firstname","lastname","handleApplyAddress","variables","handleCancel","errorMessage"],"mappings":";;;;;;;AAAA;;AACA;;AAEA;;AACA;;AACA;;AACA;;AAEO,MAAMA,cAAc,GAAGC,KAAK,IAAI;AACnC,QAAM;AACFC,IAAAA,SAAS,EAAE;AAAEC,MAAAA;AAAF,KADT;AAEFC,IAAAA,OAAO,EAAE;AAAEC,MAAAA,yBAAF;AAA6BC,MAAAA;AAA7B,KAFP;AAGFC,IAAAA;AAHE,MAIFN,KAJJ;AAMA,QAAM,GAAG;AAAEO,IAAAA;AAAF,GAAH,IAAuB,yBAA7B;AACA,QAAM,CAAC;AAAEC,IAAAA;AAAF,GAAD,IAAe,2BAArB;AACA,QAAM,CAAC;AAAEC,IAAAA;AAAF,GAAD,IAAmB,2BAAzB;AAEA,QAAMC,YAAY,GAAG,oBAArB;AACA,QAAM,CAACC,aAAD,EAAgBC,gBAAhB,IAAoC,sBAA1C;AACA,QAAM,CAACC,eAAD,EAAkBC,kBAAlB,IAAwC,sBAA9C;AAEA,QAAM,CACFC,wBADE,EAEF;AACIC,IAAAA,KAAK,EAAEC,6BADX;AAEIC,IAAAA,OAAO,EAAEC;AAFb,GAFE,IAMF,yBAAYjB,gCAAZ,CANJ;AAQA,QAAM;AACFkB,IAAAA,IAAI,EAAEC,qBADJ;AAEFH,IAAAA,OAAO,EAAEI;AAFP,MAGF,sBAASlB,yBAAT,EAAoC;AACpCmB,IAAAA,WAAW,EAAE,mBADuB;AAEpCC,IAAAA,eAAe,EAAE,aAFmB;AAGpCC,IAAAA,IAAI,EAAE,CAAChB;AAH6B,GAApC,CAHJ;AASA,QAAM;AACFW,IAAAA,IAAI,EAAEM,uBADJ;AAEFR,IAAAA,OAAO,EAAES;AAFP,MAGF,sBAAStB,2BAAT,EAAsC;AACtCkB,IAAAA,WAAW,EAAE,mBADyB;AAEtCC,IAAAA,eAAe,EAAE,aAFqB;AAGtCC,IAAAA,IAAI,EAAE,CAAChB;AAH+B,GAAtC,CAHJ;AASA,QAAMmB,mBAAmB,GAAG,oBACxB,MAAM,4CAAmB,CAACX,6BAAD,CAAnB,CADkB,EAExB,CAACA,6BAAD,CAFwB,CAA5B;AAKA,QAAMY,SAAS,GACXP,wBAAwB,IACxBK,0BADA,IAEAR,+BAHJ;AAKA,QAAMW,iBAAiB,GAClBT,qBAAqB,IAAIA,qBAAqB,CAACU,QAAtB,CAA+BC,SAAzD,IACA,EAFJ;AAIA,wBAAU,MAAM;AACZ,QAAIF,iBAAiB,CAACG,MAAlB,KAA6BvB,YAAY,CAACwB,OAA9C,EAAuD;AACnD;AACA,UAAIxB,YAAY,CAACwB,OAAjB,EAA0B;AACtB,cAAMC,aAAa,GACfL,iBAAiB,CAACA,iBAAiB,CAACG,MAAlB,GAA2B,CAA5B,CADrB;AAEAnB,QAAAA,kBAAkB,CAACqB,aAAa,CAACC,EAAf,CAAlB;AACH;;AAED1B,MAAAA,YAAY,CAACwB,OAAb,GAAuBJ,iBAAiB,CAACG,MAAzC;AACH;AACJ,GAXD,EAWG,CAACH,iBAAD,CAXH;AAaA,QAAMO,iBAAiB,GAAG,wBACtBC,OAAO,IAAI;AACP1B,IAAAA,gBAAgB,CAAC0B,OAAD,CAAhB;AACA/B,IAAAA,YAAY,CAAC,0BAAD,CAAZ;AACH,GAJqB,EAKtB,CAACA,YAAD,CALsB,CAA1B;AAQA,QAAMgC,gBAAgB,GAAG,wBAAY,MAAM;AACvCF,IAAAA,iBAAiB;AACpB,GAFwB,EAEtB,CAACA,iBAAD,CAFsB,CAAzB;AAIA,QAAMG,mBAAmB,GAAG,wBAAYC,SAAS,IAAI;AACjD3B,IAAAA,kBAAkB,CAAC2B,SAAD,CAAlB;AACH,GAF2B,EAEzB,EAFyB,CAA5B,CAhFmC,CAoFnC;AACA;;AACA,MACIX,iBAAiB,CAACG,MAAlB,IACAP,uBADA,IAEA,CAACb,eAHL,EAIE;AACE,UAAM;AAAE6B,MAAAA;AAAF,QAAmBhB,uBAAzB;AACA,UAAM;AAAEiB,MAAAA,kBAAkB,EAAEC;AAAtB,QAA4CF,YAAlD;;AACA,QAAIE,iBAAiB,CAACX,MAAtB,EAA8B;AAC1B,YAAMY,kBAAkB,GAAGD,iBAAiB,CAAC,CAAD,CAA5C;AAEA,YAAME,oBAAoB,GAAGhB,iBAAiB,CAACiB,IAAlB,CACzBC,eAAe,IACXA,eAAe,CAACC,MAAhB,CAAuB,CAAvB,MACIJ,kBAAkB,CAACI,MAAnB,CAA0B,CAA1B,CADJ,IAEAD,eAAe,CAACE,SAAhB,KACIL,kBAAkB,CAACK,SAHvB,IAIAF,eAAe,CAACG,QAAhB,KAA6BN,kBAAkB,CAACM,QAN3B,CAA7B;;AASA,UAAIL,oBAAJ,EAA0B;AACtBhC,QAAAA,kBAAkB,CAACgC,oBAAoB,CAACV,EAAtB,CAAlB;AACH;AACJ;AACJ;;AAED,QAAMgB,kBAAkB,GAAG,wBAAY,YAAY;AAC/C,QAAI;AACA,YAAMrC,wBAAwB,CAAC;AAC3BsC,QAAAA,SAAS,EAAE;AACP7C,UAAAA,MADO;AAEPiC,UAAAA,SAAS,EAAE5B;AAFJ;AADgB,OAAD,CAA9B;AAMH,KAPD,CAOE,MAAM;AACJ;AACH;;AAEDP,IAAAA,mBAAmB;AACtB,GAb0B,EAaxB,CACCE,MADD,EAECK,eAFD,EAGCE,wBAHD,EAICT,mBAJD,CAbwB,CAA3B;AAoBA,QAAMgD,YAAY,GAAG,wBAAY,MAAM;AACnCxC,IAAAA,kBAAkB;AAClBR,IAAAA,mBAAmB;AACtB,GAHoB,EAGlB,CAACA,mBAAD,CAHkB,CAArB;AAKA,SAAO;AACHK,IAAAA,aADG;AAEHmB,IAAAA,iBAFG;AAGHyB,IAAAA,YAAY,EAAE3B,mBAHX;AAIHC,IAAAA,SAJG;AAKHU,IAAAA,gBALG;AAMHa,IAAAA,kBANG;AAOHE,IAAAA,YAPG;AAQHd,IAAAA,mBARG;AASHH,IAAAA,iBATG;AAUHxB,IAAAA;AAVG,GAAP;AAYH,CApJM","sourcesContent":["import { useCallback, useEffect, useState, useRef, useMemo } from 'react';\nimport { useMutation, useQuery } from '@apollo/client';\n\nimport { useAppContext } from '../../../context/app';\nimport { useCartContext } from '../../../context/cart';\nimport { useUserContext } from '../../../context/user';\nimport { deriveErrorMessage } from '../../../util/deriveErrorMessage';\n\nexport const useAddressBook = props => {\n    const {\n        mutations: { setCustomerAddressOnCartMutation },\n        queries: { getCustomerAddressesQuery, getCustomerCartAddressQuery },\n        toggleActiveContent\n    } = props;\n\n    const [, { toggleDrawer }] = useAppContext();\n    const [{ cartId }] = useCartContext();\n    const [{ isSignedIn }] = useUserContext();\n\n    const addressCount = useRef();\n    const [activeAddress, setActiveAddress] = useState();\n    const [selectedAddress, setSelectedAddress] = useState();\n\n    const [\n        setCustomerAddressOnCart,\n        {\n            error: setCustomerAddressOnCartError,\n            loading: setCustomerAddressOnCartLoading\n        }\n    ] = useMutation(setCustomerAddressOnCartMutation);\n\n    const {\n        data: customerAddressesData,\n        loading: customerAddressesLoading\n    } = useQuery(getCustomerAddressesQuery, {\n        fetchPolicy: 'cache-and-network',\n        nextFetchPolicy: 'cache-first',\n        skip: !isSignedIn\n    });\n\n    const {\n        data: customerCartAddressData,\n        loading: customerCartAddressLoading\n    } = useQuery(getCustomerCartAddressQuery, {\n        fetchPolicy: 'cache-and-network',\n        nextFetchPolicy: 'cache-first',\n        skip: !isSignedIn\n    });\n\n    const derivedErrorMessage = useMemo(\n        () => deriveErrorMessage([setCustomerAddressOnCartError]),\n        [setCustomerAddressOnCartError]\n    );\n\n    const isLoading =\n        customerAddressesLoading ||\n        customerCartAddressLoading ||\n        setCustomerAddressOnCartLoading;\n\n    const customerAddresses =\n        (customerAddressesData && customerAddressesData.customer.addresses) ||\n        [];\n\n    useEffect(() => {\n        if (customerAddresses.length !== addressCount.current) {\n            // Auto-select newly added address when count changes\n            if (addressCount.current) {\n                const newestAddress =\n                    customerAddresses[customerAddresses.length - 1];\n                setSelectedAddress(newestAddress.id);\n            }\n\n            addressCount.current = customerAddresses.length;\n        }\n    }, [customerAddresses]);\n\n    const handleEditAddress = useCallback(\n        address => {\n            setActiveAddress(address);\n            toggleDrawer('shippingInformation.edit');\n        },\n        [toggleDrawer]\n    );\n\n    const handleAddAddress = useCallback(() => {\n        handleEditAddress();\n    }, [handleEditAddress]);\n\n    const handleSelectAddress = useCallback(addressId => {\n        setSelectedAddress(addressId);\n    }, []);\n\n    // GraphQL doesn't return which customer address is selected, so perform\n    // a simple search to initialize this selected address value.\n    if (\n        customerAddresses.length &&\n        customerCartAddressData &&\n        !selectedAddress\n    ) {\n        const { customerCart } = customerCartAddressData;\n        const { shipping_addresses: shippingAddresses } = customerCart;\n        if (shippingAddresses.length) {\n            const primaryCartAddress = shippingAddresses[0];\n\n            const foundSelectedAddress = customerAddresses.find(\n                customerAddress =>\n                    customerAddress.street[0] ===\n                        primaryCartAddress.street[0] &&\n                    customerAddress.firstname ===\n                        primaryCartAddress.firstname &&\n                    customerAddress.lastname === primaryCartAddress.lastname\n            );\n\n            if (foundSelectedAddress) {\n                setSelectedAddress(foundSelectedAddress.id);\n            }\n        }\n    }\n\n    const handleApplyAddress = useCallback(async () => {\n        try {\n            await setCustomerAddressOnCart({\n                variables: {\n                    cartId,\n                    addressId: selectedAddress\n                }\n            });\n        } catch {\n            return;\n        }\n\n        toggleActiveContent();\n    }, [\n        cartId,\n        selectedAddress,\n        setCustomerAddressOnCart,\n        toggleActiveContent\n    ]);\n\n    const handleCancel = useCallback(() => {\n        setSelectedAddress();\n        toggleActiveContent();\n    }, [toggleActiveContent]);\n\n    return {\n        activeAddress,\n        customerAddresses,\n        errorMessage: derivedErrorMessage,\n        isLoading,\n        handleAddAddress,\n        handleApplyAddress,\n        handleCancel,\n        handleSelectAddress,\n        handleEditAddress,\n        selectedAddress\n    };\n};\n"]}