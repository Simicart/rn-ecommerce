{"version":3,"sources":["usePaymentInformation.js"],"names":["useCallback","useState","useEffect","useQuery","useApolloClient","useMutation","useAppContext","useCartContext","CheckoutError","CHECKOUT_STEP","usePaymentInformation","props","mutations","onSave","checkoutError","queries","resetShouldSubmit","setCheckoutStep","shouldSubmit","setFreePaymentMethodMutation","setBillingAddressMutation","getPaymentInformation","getPaymentNonceQuery","doneEditing","setDoneEditing","drawer","toggleDrawer","closeDrawer","isEditModalActive","cartId","client","showEditModal","hideEditModal","handlePaymentSuccess","handlePaymentError","data","paymentInformationData","loading","paymentInformationLoading","fetchPolicy","nextFetchPolicy","skip","variables","setFreePaymentMethod","setFreePaymentMethodLoading","clearPaymentDetails","writeQuery","query","cart","__typename","id","paymentNonce","setBillingAddress","isLoading","availablePaymentMethods","available_payment_methods","selectedPaymentMethod","selected_payment_method","code","find","PAYMENT","setFreeIfAvailable","freeIsAvailable","shippingAddressOnCart","shipping_addresses","length","firstname","lastname","street","city","region","postcode","country","telephone","regionCode","countryCode","handleExpiredPaymentError","hasPaymentExpired"],"mappings":"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","sourcesContent":["import { useCallback, useState, useEffect } from 'react';\nimport { useQuery, useApolloClient, useMutation } from '@apollo/client';\n\nimport { useAppContext } from '../../../context/app';\nimport { useCartContext } from '../../../context/cart';\nimport CheckoutError from '../CheckoutError';\nimport { CHECKOUT_STEP } from '../useCheckoutPage';\n\n/**\n *\n * @param {Function} props.onSave callback to be called when user clicks review order button\n * @param {Object} props.checkoutError an instance of the `CheckoutError` error that has been generated using the error from the place order mutation\n * @param {DocumentNode} props.queries.getPaymentNonceQuery query to fetch and/or clear payment nonce from cache\n * @param {Boolean} props.shouldSubmit property telling us to proceed to next step\n * @param {Function} props.resetShouldSubmit callback to reset the review order button flag\n * @param {DocumentNode} props.queries.getPaymentInformation query to fetch data to render this component\n * @param {DocumentNode} props.mutation.setBillingAddressMutation\n * @param {DocumentNode} props.mutation.setFreePaymentMethodMutation\n *\n * @returns {\n *   doneEditing: Boolean,\n *   isEditModalActive: Boolean,\n *   showEditModal: Function,\n *   hideEditModal: Function,\n *   handlePaymentError: Function,\n *   handlePaymentSuccess: Function,\n *   checkoutStep: Number,\n *\n * }\n */\nexport const usePaymentInformation = props => {\n    const {\n        mutations,\n        onSave,\n        checkoutError,\n        queries,\n        resetShouldSubmit,\n        setCheckoutStep,\n        shouldSubmit\n    } = props;\n    const {\n        setFreePaymentMethodMutation,\n        setBillingAddressMutation\n    } = mutations;\n    const { getPaymentInformation, getPaymentNonceQuery } = queries;\n\n    /**\n     * Definitions\n     */\n\n    const [doneEditing, setDoneEditing] = useState(false);\n    const [{ drawer }, { toggleDrawer, closeDrawer }] = useAppContext();\n    const isEditModalActive = drawer === 'edit.payment';\n    const [{ cartId }] = useCartContext();\n    const client = useApolloClient();\n\n    /**\n     * Helper Functions\n     */\n\n    const showEditModal = useCallback(() => {\n        toggleDrawer('edit.payment');\n    }, [toggleDrawer]);\n\n    const hideEditModal = useCallback(() => {\n        closeDrawer('edit.payment');\n    }, [closeDrawer]);\n\n    const handlePaymentSuccess = useCallback(() => {\n        setDoneEditing(true);\n        if (onSave) {\n            onSave();\n        }\n    }, [onSave]);\n\n    const handlePaymentError = useCallback(() => {\n        resetShouldSubmit();\n        setDoneEditing(false);\n    }, [resetShouldSubmit]);\n\n    /**\n     * Queries\n     */\n    const {\n        data: paymentInformationData,\n        loading: paymentInformationLoading\n    } = useQuery(getPaymentInformation, {\n        fetchPolicy: 'cache-and-network',\n        nextFetchPolicy: 'cache-first',\n        skip: !cartId,\n        variables: { cartId }\n    });\n\n    const [\n        setFreePaymentMethod,\n        { loading: setFreePaymentMethodLoading }\n    ] = useMutation(setFreePaymentMethodMutation);\n\n    const clearPaymentDetails = useCallback(() => {\n        client.writeQuery({\n            query: getPaymentNonceQuery,\n            data: {\n                cart: {\n                    __typename: 'Cart',\n                    id: cartId,\n                    paymentNonce: null\n                }\n            }\n        });\n    }, [cartId, client, getPaymentNonceQuery]);\n\n    const [setBillingAddress] = useMutation(setBillingAddressMutation);\n\n    // We must wait for payment method to be set if this is the first time we\n    // are hitting this component and the total is $0. If we don't wait then\n    // the CC component will mount while the setPaymentMethod mutation is in flight.\n    const isLoading = paymentInformationLoading || setFreePaymentMethodLoading;\n\n    /**\n     * Effects\n     */\n\n    const availablePaymentMethods = paymentInformationData\n        ? paymentInformationData.cart.available_payment_methods\n        : [];\n\n    const selectedPaymentMethod =\n        (paymentInformationData &&\n            paymentInformationData.cart.selected_payment_method.code) ||\n        null;\n\n    // Whenever selected payment method is no longer an available method we\n    // should reset to the payment step to force the user to select again.\n    useEffect(() => {\n        if (\n            !availablePaymentMethods.find(\n                ({ code }) => code === selectedPaymentMethod\n            )\n        ) {\n            resetShouldSubmit();\n            setCheckoutStep(CHECKOUT_STEP.PAYMENT);\n            setDoneEditing(false);\n        }\n    }, [\n        availablePaymentMethods,\n        resetShouldSubmit,\n        selectedPaymentMethod,\n        setCheckoutStep\n    ]);\n\n    // If free is ever available and not selected, automatically select it.\n    useEffect(() => {\n        const setFreeIfAvailable = async () => {\n            const freeIsAvailable = !!availablePaymentMethods.find(\n                ({ code }) => code === 'free'\n            );\n            if (freeIsAvailable) {\n                if (selectedPaymentMethod !== 'free') {\n                    await setFreePaymentMethod({\n                        variables: {\n                            cartId\n                        }\n                    });\n                    setDoneEditing(true);\n                } else {\n                    setDoneEditing(true);\n                }\n            }\n        };\n        setFreeIfAvailable();\n    }, [\n        availablePaymentMethods,\n        cartId,\n        selectedPaymentMethod,\n        setDoneEditing,\n        setFreePaymentMethod\n    ]);\n\n    const shippingAddressOnCart =\n        (paymentInformationData &&\n            paymentInformationData.cart.shipping_addresses.length &&\n            paymentInformationData.cart.shipping_addresses[0]) ||\n        null;\n\n    // If the selected payment method is \"free\" keep the shipping address\n    // synced with billing address.This _requires_ the UI does not allow payment\n    // information before shipping address.\n    useEffect(() => {\n        if (selectedPaymentMethod === 'free' && shippingAddressOnCart) {\n            const {\n                firstname,\n                lastname,\n                street,\n                city,\n                region,\n                postcode,\n                country,\n                telephone\n            } = shippingAddressOnCart;\n            const regionCode = region.code;\n            const countryCode = country.code;\n\n            setBillingAddress({\n                variables: {\n                    cartId,\n                    firstname,\n                    lastname,\n                    street,\n                    city,\n                    regionCode,\n                    postcode,\n                    countryCode,\n                    telephone\n                }\n            });\n        }\n    }, [\n        cartId,\n        selectedPaymentMethod,\n        setBillingAddress,\n        shippingAddressOnCart\n    ]);\n\n    // When the \"review order\" button is clicked, if the selected method is free\n    // and free is still available, proceed.\n    useEffect(() => {\n        if (\n            shouldSubmit &&\n            availablePaymentMethods.find(({ code }) => code === 'free') &&\n            selectedPaymentMethod === 'free'\n        ) {\n            onSave();\n        }\n    });\n\n    const handleExpiredPaymentError = useCallback(() => {\n        setDoneEditing(false);\n        clearPaymentDetails({ variables: { cartId } });\n        resetShouldSubmit();\n        setCheckoutStep(CHECKOUT_STEP.PAYMENT);\n    }, [resetShouldSubmit, setCheckoutStep, clearPaymentDetails, cartId]);\n\n    useEffect(() => {\n        if (\n            checkoutError instanceof CheckoutError &&\n            checkoutError.hasPaymentExpired()\n        ) {\n            handleExpiredPaymentError();\n        }\n    }, [checkoutError, handleExpiredPaymentError]);\n\n    return {\n        doneEditing,\n        isEditModalActive,\n        isLoading,\n        handlePaymentError,\n        handlePaymentSuccess,\n        hideEditModal,\n        showEditModal\n    };\n};\n"]}