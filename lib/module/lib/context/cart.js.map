{"version":3,"sources":["cart.js"],"names":["React","createContext","useContext","useEffect","useMemo","connect","useApolloClient","useMutation","gql","useAwaitQuery","actions","asyncActions","bindActionCreators","CartContext","isCartEmpty","cart","details","items","length","getTotalQuantity","reduce","total","item","quantity","CartContextProvider","props","cartState","children","derivedDetails","currencyCode","numItems","subtotal","prices","grand_total","currency","value","derivedCartState","isEmpty","cartApi","contextValue","apolloClient","fetchCartId","CREATE_CART_MUTATION","fetchCartDetails","CART_DETAILS_QUERY","getCartDetails","mapStateToProps","mapDispatchToProps","dispatch","useCartContext"],"mappings":"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","sourcesContent":["import React, { createContext, useContext, useEffect, useMemo } from 'react';\nimport { connect } from 'react-redux';\nimport { useApolloClient, useMutation } from '@apollo/client';\nimport gql from 'graphql-tag';\n\nimport { useAwaitQuery} from '../hooks/useAwaitQuery';\nimport actions from '../store/actions/cart/actions';\nimport * as asyncActions from '../store/actions/cart/asyncActions';\nimport bindActionCreators from '../util/bindActionCreators';\n\nconst CartContext = createContext();\n\nconst isCartEmpty = cart =>\n    !cart || !cart.details.items || cart.details.items.length === 0;\n\nconst getTotalQuantity = items =>\n    items.reduce((total, item) => total + item.quantity, 0);\n\nconst CartContextProvider = props => {\n    const { actions, asyncActions, cartState, children } = props;\n\n    // Make deeply nested details easier to retrieve and provide empty defaults\n    const derivedDetails = useMemo(() => {\n        if (isCartEmpty(cartState)) {\n            return {\n                currencyCode: 'USD',\n                numItems: 0,\n                subtotal: 0\n            };\n        } else {\n            return {\n                currencyCode: cartState.details.prices.grand_total.currency,\n                numItems: getTotalQuantity(cartState.details.items),\n                subtotal: cartState.details.prices.grand_total.value\n            };\n        }\n    }, [cartState]);\n\n    const derivedCartState = {\n        ...cartState,\n        isEmpty: isCartEmpty(cartState),\n        derivedDetails\n    };\n\n    const cartApi = useMemo(\n        () => ({\n            actions,\n            ...asyncActions\n        }),\n        [actions, asyncActions]\n    );\n\n    const contextValue = useMemo(() => [derivedCartState, cartApi], [\n        cartApi,\n        derivedCartState\n    ]);\n\n    const apolloClient = useApolloClient();\n    const [fetchCartId] = useMutation(CREATE_CART_MUTATION);\n    const fetchCartDetails = useAwaitQuery(CART_DETAILS_QUERY);\n\n    useEffect(() => {\n        // cartApi.getCartDetails initializes the cart if there isn't one. Also, we pass\n        // apolloClient to wipe the store in event of auth token expiry which\n        // will only happen if the user refreshes.\n        cartApi.getCartDetails({\n            apolloClient,\n            fetchCartId,\n            fetchCartDetails\n        });\n    }, [apolloClient, cartApi, fetchCartDetails, fetchCartId]);\n\n    return (\n        <CartContext.Provider value={contextValue}>\n            {children}\n        </CartContext.Provider>\n    );\n};\n\nconst mapStateToProps = ({ cart }) => ({ cartState: cart });\n\nconst mapDispatchToProps = dispatch => ({\n    actions: bindActionCreators(actions, dispatch),\n    asyncActions: bindActionCreators(asyncActions, dispatch)\n});\n\nexport default connect(\n    mapStateToProps,\n    mapDispatchToProps\n)(CartContextProvider);\n\nexport const useCartContext = () => useContext(CartContext);\n\n/**\n * We normally do not keep GQL queries in Peregrine. All components should pass\n * queries to talons/hooks. This is an exception to the rule because it would\n * be unecessarily complex to pass these queries to the context provider.\n */\nconst CREATE_CART_MUTATION = gql`\n    mutation createCart {\n        cartId: createEmptyCart\n    }\n`;\n\nconst CART_DETAILS_QUERY = gql`\n    query checkUserIsAuthed($cartId: String!) {\n        cart(cart_id: $cartId) {\n            # The purpose of this query is to check that the user is authorized\n            # to query on the current cart. Just fetch \"id\" to keep it small.\n            id\n        }\n    }\n`;\n"]}